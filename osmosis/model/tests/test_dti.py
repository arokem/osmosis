import os
import tempfile

import numpy as np
import numpy.testing as npt


import osmosis as oz
import osmosis.utils as ozu
from osmosis.model.dti import TensorModel, tensor_coherence, tensor_dispersion

data_path = os.path.split(oz.__file__)[0] + '/data/'


@npt.decorators.slow
def test_TensorModel():

    # Cover both cases:
    # 1. Get the params from a file in the data directory (that's the default
    # behavior when params_file is set to None), or calculate the params and
    # store them in a tempfile: 
    for params_file in [None, tempfile.NamedTemporaryFile().name]: 
        TM = TensorModel(data_path + 'small_dwi.nii.gz',
                             data_path + 'dwi.bvecs',
                             data_path + 'dwi.bvals',
                             params_file=params_file)
        # Test for regressions: 
        npt.assert_almost_equal(TM.model_params,
    np.array([[[[ 0.72498638,  0.62960292,  0.43976463, -0.52642858,  0.28215774,
           0.80203489, -0.55736354, -0.82687994, -0.07493629, -0.64204271,
           0.48647361, -0.59255766],
         [ 0.87160882,  0.65340932,  0.44609867, -0.12833828,  0.54628941,
          -0.82770597, -0.91939715, -0.37843624, -0.10721424, -0.37180394,
           0.74723082,  0.55082478],
         [ 0.93262054,  0.70550148,  0.39589965, -0.20545516,  0.64598017,
          -0.73518556, -0.93395784, -0.35387746, -0.04993483, -0.29242251,
           0.67637295,  0.67602419],
         [ 1.00267148,  0.80461195,  0.52487392, -0.30616187, -0.63111216,
           0.71271477, -0.86688379,  0.4942219 ,  0.06524727, -0.39341759,
          -0.59786466, -0.69841281]],

        [[ 0.77462729,  0.67006414,  0.42860996,  0.28995204, -0.64891692,
           0.70344484, -0.76761166, -0.59666561, -0.23401386,  0.5715769 ,
          -0.47211967, -0.67112061],
         [ 0.74914162,  0.67623952,  0.46713387, -0.06503916,  0.68896914,
          -0.72186663, -0.99614914, -0.08744913,  0.00628779, -0.05879451,
           0.71949578,  0.69200363],
         [ 0.91580675,  0.68152544,  0.43348596, -0.3960896 , -0.65307455,
           0.64545074, -0.86794512,  0.49568638, -0.03108506, -0.29964028,
          -0.57252829, -0.76316909],
         [ 1.25077171,  0.95521377,  0.63629634, -0.47511005, -0.56273191,
           0.67646378, -0.81433567,  0.57244257, -0.09574402, -0.33335845,
          -0.59635753, -0.73022588]]],


       [[[ 0.7675704 ,  0.63407061,  0.45336867, -0.65319901,  0.15743821,
           0.74063774, -0.42212631, -0.88775441, -0.18357965, -0.62860197,
           0.43255672, -0.64633911],
         [ 0.91662169,  0.65381287,  0.4772092 , -0.6240085 ,  0.32633289,
          -0.71001425, -0.56678443, -0.81451687,  0.12376464, -0.53793011,
           0.4796552 ,  0.69322586],
         [ 0.92254438,  0.83011048,  0.43516582, -0.61028398,  0.39320749,
           0.68770731, -0.56591139, -0.82387797, -0.03113486, -0.55434445,
           0.4081825 , -0.72532012],
         [ 0.85523229,  0.7438308 ,  0.43092755, -0.17010331,  0.71660702,
          -0.67641647, -0.94931018, -0.3032974 , -0.08258853, -0.26433888,
           0.62808046,  0.73187423]],

        [[ 0.77521873,  0.66279218,  0.51844717, -0.52480981, -0.52593874,
           0.66930046, -0.78629554,  0.60071452, -0.14450396, -0.32605827,
          -0.60210506, -0.72880415],
         [ 0.7947062 ,  0.61261263,  0.45925385, -0.50593116,  0.60846211,
          -0.61139801, -0.81226521, -0.57459834,  0.10030939, -0.29027381,
           0.54736698,  0.78493981],
         [ 0.90555661,  0.68982838,  0.385382  , -0.50834098, -0.60623625,
           0.61161022, -0.79939086,  0.59631876, -0.07333606, -0.32025567,
          -0.52619534, -0.78775299],
         [ 1.18773376,  0.93254344,  0.6212184 , -0.31668715, -0.66857912,
           0.67283817, -0.9070882 ,  0.42084952, -0.0087569 , -0.27730894,
          -0.61309676, -0.73973786]]],


       [[[ 0.78179326,  0.63508328,  0.41124321,  0.75024941, -0.00338089,
          -0.66114628,  0.21958644, -0.94194866,  0.25399708,  0.62362458,
           0.33573992,  0.70595402],
         [ 0.86322687,  0.67444383,  0.45634396, -0.77090221,  0.25515136,
           0.58361594, -0.48408757, -0.83019054, -0.27648307, -0.4139674 ,
           0.49566263, -0.76351133],
         [ 0.83765462,  0.76937278,  0.47534781,  0.73549973,  0.17303064,
          -0.65505767,  0.2749366 , -0.95987926,  0.05515129,  0.61923341,
           0.22066309,  0.75356339],
         [ 0.85897404,  0.72855683,  0.42774014, -0.45016025, -0.65845131,
           0.60315639, -0.80848731,  0.58730247,  0.03773687, -0.37908313,
          -0.47065665, -0.79672975]],

        [[ 0.78781523,  0.59762529,  0.44501128, -0.77584255,  0.21888049,
          -0.59174291, -0.49368192, -0.79462052,  0.35335025, -0.39286958,
           0.56627693,  0.72455775],
         [ 0.84462938,  0.63667939,  0.3970623 , -0.67626912,  0.45586692,
           0.5786583 , -0.65249153, -0.73529522, -0.18329143, -0.34192818,
           0.50152397, -0.79470675],
         [ 0.80049902,  0.65778736,  0.37540944, -0.6430365 ,  0.53282511,
           0.55009222, -0.69124081, -0.71302586, -0.11738939, -0.32968196,
           0.45573186, -0.82681212],
         [ 0.84105437,  0.68354718,  0.42559984, -0.38448618, -0.72041699,
           0.57720858, -0.90775652,  0.40869882, -0.09456939, -0.16777508,
          -0.56032548, -0.81110227]]]]))

        npt.assert_almost_equal(TM.evals,
        np.array([[[[ 0.72498638,  0.62960292,  0.43976463],
         [ 0.87160882,  0.65340932,  0.44609867],
         [ 0.93262054,  0.70550148,  0.39589965],
         [ 1.00267148,  0.80461195,  0.52487392]],

        [[ 0.77462729,  0.67006414,  0.42860996],
         [ 0.74914162,  0.67623952,  0.46713387],
         [ 0.91580675,  0.68152544,  0.43348596],
         [ 1.25077171,  0.95521377,  0.63629634]]],


       [[[ 0.7675704 ,  0.63407061,  0.45336867],
         [ 0.91662169,  0.65381287,  0.4772092 ],
         [ 0.92254438,  0.83011048,  0.43516582],
         [ 0.85523229,  0.7438308 ,  0.43092755]],

        [[ 0.77521873,  0.66279218,  0.51844717],
         [ 0.7947062 ,  0.61261263,  0.45925385],
         [ 0.90555661,  0.68982838,  0.385382  ],
         [ 1.18773376,  0.93254344,  0.6212184 ]]],


       [[[ 0.78179326,  0.63508328,  0.41124321],
         [ 0.86322687,  0.67444383,  0.45634396],
         [ 0.83765462,  0.76937278,  0.47534781],
         [ 0.85897404,  0.72855683,  0.42774014]],

        [[ 0.78781523,  0.59762529,  0.44501128],
         [ 0.84462938,  0.63667939,  0.3970623 ],
         [ 0.80049902,  0.65778736,  0.37540944],
         [ 0.84105437,  0.68354718,  0.42559984]]]]))
        
        npt.assert_almost_equal(TM.evecs,
        np.array([[[[[-0.52642858,  0.28215774,  0.80203489],
          [-0.55736354, -0.82687994, -0.07493629],
          [-0.64204271,  0.48647361, -0.59255766]],

         [[-0.12833828,  0.54628941, -0.82770597],
          [-0.91939715, -0.37843624, -0.10721424],
          [-0.37180394,  0.74723082,  0.55082478]],

         [[-0.20545516,  0.64598017, -0.73518556],
          [-0.93395784, -0.35387746, -0.04993483],
          [-0.29242251,  0.67637295,  0.67602419]],

         [[-0.30616187, -0.63111216,  0.71271477],
          [-0.86688379,  0.4942219 ,  0.06524727],
          [-0.39341759, -0.59786466, -0.69841281]]],


        [[[ 0.28995204, -0.64891692,  0.70344484],
          [-0.76761166, -0.59666561, -0.23401386],
          [ 0.5715769 , -0.47211967, -0.67112061]],

         [[-0.06503916,  0.68896914, -0.72186663],
          [-0.99614914, -0.08744913,  0.00628779],
          [-0.05879451,  0.71949578,  0.69200363]],

         [[-0.3960896 , -0.65307455,  0.64545074],
          [-0.86794512,  0.49568638, -0.03108506],
          [-0.29964028, -0.57252829, -0.76316909]],

         [[-0.47511005, -0.56273191,  0.67646378],
          [-0.81433567,  0.57244257, -0.09574402],
          [-0.33335845, -0.59635753, -0.73022588]]]],



       [[[[-0.65319901,  0.15743821,  0.74063774],
          [-0.42212631, -0.88775441, -0.18357965],
          [-0.62860197,  0.43255672, -0.64633911]],

         [[-0.6240085 ,  0.32633289, -0.71001425],
          [-0.56678443, -0.81451687,  0.12376464],
          [-0.53793011,  0.4796552 ,  0.69322586]],

         [[-0.61028398,  0.39320749,  0.68770731],
          [-0.56591139, -0.82387797, -0.03113486],
          [-0.55434445,  0.4081825 , -0.72532012]],

         [[-0.17010331,  0.71660702, -0.67641647],
          [-0.94931018, -0.3032974 , -0.08258853],
          [-0.26433888,  0.62808046,  0.73187423]]],


        [[[-0.52480981, -0.52593874,  0.66930046],
          [-0.78629554,  0.60071452, -0.14450396],
          [-0.32605827, -0.60210506, -0.72880415]],

         [[-0.50593116,  0.60846211, -0.61139801],
          [-0.81226521, -0.57459834,  0.10030939],
          [-0.29027381,  0.54736698,  0.78493981]],

         [[-0.50834098, -0.60623625,  0.61161022],
          [-0.79939086,  0.59631876, -0.07333606],
          [-0.32025567, -0.52619534, -0.78775299]],

         [[-0.31668715, -0.66857912,  0.67283817],
          [-0.9070882 ,  0.42084952, -0.0087569 ],
          [-0.27730894, -0.61309676, -0.73973786]]]],



       [[[[ 0.75024941, -0.00338089, -0.66114628],
          [ 0.21958644, -0.94194866,  0.25399708],
          [ 0.62362458,  0.33573992,  0.70595402]],

         [[-0.77090221,  0.25515136,  0.58361594],
          [-0.48408757, -0.83019054, -0.27648307],
          [-0.4139674 ,  0.49566263, -0.76351133]],

         [[ 0.73549973,  0.17303064, -0.65505767],
          [ 0.2749366 , -0.95987926,  0.05515129],
          [ 0.61923341,  0.22066309,  0.75356339]],

         [[-0.45016025, -0.65845131,  0.60315639],
          [-0.80848731,  0.58730247,  0.03773687],
          [-0.37908313, -0.47065665, -0.79672975]]],


        [[[-0.77584255,  0.21888049, -0.59174291],
          [-0.49368192, -0.79462052,  0.35335025],
          [-0.39286958,  0.56627693,  0.72455775]],

         [[-0.67626912,  0.45586692,  0.5786583 ],
          [-0.65249153, -0.73529522, -0.18329143],
          [-0.34192818,  0.50152397, -0.79470675]],

         [[-0.6430365 ,  0.53282511,  0.55009222],
          [-0.69124081, -0.71302586, -0.11738939],
          [-0.32968196,  0.45573186, -0.82681212]],

         [[-0.38448618, -0.72041699,  0.57720858],
          [-0.90775652,  0.40869882, -0.09456939],
          [-0.16777508, -0.56032548, -0.81110227]]]]]))

        npt.assert_almost_equal(TM.mean_diffusivity,
        np.array([[[ 0.59811798,  0.65703894,  0.67800722,  0.77738579],
        [ 0.6244338 ,  0.63083833,  0.67693938,  0.94742728]],

       [[ 0.61833656,  0.68254792,  0.72927356,  0.67666355],
        [ 0.65215269,  0.6221909 ,  0.66025566,  0.91383187]],

       [[ 0.60937325,  0.66467155,  0.69412507,  0.671757  ],
        [ 0.6101506 ,  0.62612369,  0.61123194,  0.65006713]]]))
        
        npt.assert_almost_equal(TM.adc[0][0],
    np.array([[ 0.5628663 ,  0.440081  ,  1.32796057,  0.76302815,  0.6059036 ,
         0.88430897,  0.98138698,  0.46066004,  0.45232651,  0.67186737,
         0.73316853,  0.56804769,  0.67831908,  0.52802634,  0.61155338,
         0.71188873,  0.47775572,  0.87459993,  0.6059036 ,  0.79478485,
         0.66549786,  0.5628663 ,  1.04476283,  0.60031695,  0.46487947,
         0.88430897,  0.42031558,  0.84655519,  0.61155338,  0.77865442,
         0.36185492,  0.55266186,  0.50454785,  0.44821126,  0.44821126,
         0.39023132,  0.69147773,  0.99343575,  0.55266186,  0.64686216,
         0.83754594,  0.68485512,  0.64080148,  0.33174549,  0.41262313,
         0.57328334,  0.49097235,  0.56804769,  0.5893275 ,  1.05846232,
         0.37940058,  0.56804769,  0.75539442,  0.55773805,  0.51380737,
         0.85572976,  0.440081  ,  0.46913482,  0.37940058,  0.85572976,
         0.51850224,  0.89421028,  0.44821126,  0.42420665,  0.93590109,
         0.28232257,  0.32529378,  1.00578206,  0.64686216,  0.88430897,
         0.50915617,  0.4999816 ,  0.82869615,  0.67186737,  0.54266153,
         0.54266153,  0.6059036 ,  0.28232257,  0.5628663 ,  0.80304951,
         0.71188873,  0.5628663 ,  0.4999816 ,  0.64686216,  0.69147773,
         0.51380737,  0.5893275 ,  0.47775572,  0.42420665,  0.72597417,
         0.86507583,  0.64686216,  0.6059036 ,  0.44412961,  0.64080148,
         0.44821126,  0.58392204,  0.43208083,  0.51850224,  0.65299721,
         0.5785744 ,  0.63481339,  0.69818924,  0.41262313,  0.43606492,
         0.63481339,  0.49545669,  0.74787548,  0.55773805,  0.46913482,
         0.35161565,  0.69818924,  0.4999816 ,  0.61726773,  0.73316853,
         0.39023132,  0.54763669,  1.08704152,  0.59479203,  0.46487947,
         0.5893275 ,  0.39023132,  0.35841848,  0.5628663 ,  0.42420665,
         0.50454785,  0.57328334,  0.46487947,  0.34158187,  0.41645456,
         0.86507583,  1.26119487,  0.31892427,  0.69147773,  0.30334669,
         0.86507583,  0.37584184,  0.51380737,  0.63481339,  0.72597417,
         0.2678288 ,  0.80304951,  0.59479203,  0.47342669,  0.37584184,
         0.73316853,  0.84655519,  0.64080148,  0.42420665,  0.67186737],
       [ 0.6348205 ,  0.74772384,  0.48832694,  0.93084603,  0.53836867,
         1.04968186,  0.53836867,  0.77512796,  0.55622771,  0.48437435,
         0.64557361,  0.75443535,  0.92132194,  0.59398149,  0.49231103,
         0.71545458,  0.38475534,  1.02586784,  0.67351383,  0.44284105,
         0.77512796,  0.77512796,  0.75443535,  0.61398415,  0.46506693,
         0.46886923,  0.52538093,  1.06202817,  0.69704759,  0.57005348,
         0.44284105,  0.70924332,  0.73456518,  0.72811348,  0.6242938 ,
         0.40786176,  0.44647743,  0.48045276,  1.58693923,  0.53400183,
         0.80412158,  1.07468707,  0.64557361,  0.30721938,  0.64016815,
         1.03763309,  0.5296728 ,  1.07468707,  0.36266973,  0.85929561,
         0.51690615,  0.79671404,  0.94055508,  0.66214971,  0.53836867,
         0.54277398,  0.88494226,  0.66779949,  0.54277398,  0.43208795,
         0.65103814,  0.78222027,  0.60890797,  0.59890764,  0.85103096,
         0.67929425,  0.66779949,  0.66779949,  0.81927426,  0.66779949,
         0.49231103,  0.65103814,  0.72174397,  0.69105949,  0.39452763,
         0.92132194,  0.74772384,  0.45383051,  0.66779949,  0.54277398,
         0.57474835,  0.56079395,  0.52112558,  0.6038828 ,  0.47656169,
         0.51272202,  0.83490053,  0.59890764,  0.51690615,  0.66214971,
         1.14328763,  0.45754799,  0.40115025,  0.82702635,  0.88494226,
         0.98139409,  0.76123817,  0.72811348,  0.39782798,  0.74772384,
         1.11470843,  0.55170279,  0.74772384,  0.53836867,  0.85929561,
         0.58427244,  0.42855437,  1.04968186,  0.65656306,  0.69105949,
         0.48437435,  0.85103096,  0.50857262,  0.61911241,  0.76813483,
         1.24036564,  0.64016815,  0.5891034 ,  0.41466458,  0.6038828 ,
         0.70310827,  0.50857262,  0.45014045,  0.74110122,  0.51272202,
         0.65103814,  0.45383051,  0.65103814,  0.66214971,  0.69105949,
         0.59398149,  0.59890764,  0.29628998,  0.70310827,  0.58427244,
         0.69105949,  0.43208795,  0.30721938,  0.78222027,  0.69105949,
         0.45383051,  0.9921472 ,  0.51272202,  0.29628998,  0.43208795,
         0.51690615,  0.78941464,  0.6348205 ,  0.46129333,  0.64557361],
       [ 0.78913617,  0.46354468,  0.6317808 ,  0.81011827,  0.6470104 ,
         0.78913617,  0.75601148,  0.65742745,  0.82461204,  0.3723839 ,
         0.58869195,  0.73100627,  0.43575975,  0.34629102,  0.29276403,
         0.6470104 ,  0.44599902,  0.75601148,  0.53647062,  0.79603283,
         1.02004519,  0.76246318,  0.4391496 ,  0.71304026,  0.45998595,
         0.47803845,  0.70719224,  0.68446106,  0.92169005,  0.40943789,
         0.29530856,  0.52020902,  0.62680563,  0.54480414,  0.6521918 ,
         0.24211836,  0.58869195,  0.45998595,  0.99876539,  0.62187948,
         0.64188215,  1.36661878,  0.94921993,  0.36646667,  0.74964196,
         0.79603283,  0.45294358,  1.02004519,  0.76899922,  1.07757986,
         0.98845574,  0.52827371,  0.92169005,  0.83953852,  0.70719224,
         0.6170014 ,  0.47437543,  0.71304026,  0.62187948,  0.46712892,
         0.78233334,  0.87892896,  0.56626667,  0.55327892,  0.67893614,
         1.34533898,  0.70141183,  0.6170014 ,  0.83201958,  0.42242563,
         0.74335257,  0.70719224,  0.53647062,  0.79603283,  0.32962281,
         0.76899922,  0.74335257,  0.42904824,  0.81731264,  0.70141183,
         0.65742745,  0.54480414,  0.69004771,  0.64188215,  0.6170014 ,
         0.60738572,  1.06553108,  0.74964196,  0.81731264,  0.97835439,
         0.81011827,  0.68446106,  0.43575975,  0.84717226,  0.83201958,
         0.74335257,  0.61217044,  0.36353411,  0.3519729 ,  0.91284026,
         1.06553108,  0.50835076,  1.26826364,  0.73714131,  0.53647062,
         0.71895749,  0.48919133,  0.89559717,  0.65742745,  0.9306993 ,
         0.34629102,  0.83201958,  0.77562183,  1.4621464 ,  0.57960079,
         0.59330028,  0.67893614,  0.75601148,  0.6170014 ,  0.70141183,
         0.6470104 ,  0.58412571,  0.38749079,  0.87892896,  0.38749079,
         0.58869195,  0.47803845,  0.52827371,  0.57511646,  0.59330028,
         0.99876539,  0.54062002,  0.45645236,  0.60264634,  0.53647062,
         0.71304026,  0.97835439,  0.59795147,  1.04227107,  1.2337672 ,
         0.45294358,  0.79603283,  0.52422511,  0.22189088,  0.47073905,
         0.6470104 ,  1.00929209,  0.81731264,  0.41265333,  0.46712892],
       [ 0.77923506,  0.49575877,  0.8111608 ,  0.85118215,  1.02782183,
         1.07209853,  0.88186662,  0.85118215,  0.69412449,  0.47289765,
         0.74922606,  0.71182545,  0.5646174 ,  0.58867702,  0.60660009,
         0.83363649,  0.67284468,  0.914558  ,  0.69412449,  0.66049837,
         1.41867212,  0.85118215,  0.75903029,  0.914558  ,  0.58516823,
         0.66458003,  0.80569626,  0.69412449,  1.02782183,  0.55795063,
         0.5646174 ,  0.57137426,  0.71635037,  0.70289664,  0.65644977,
         0.48994475,  0.88186662,  0.92825749,  1.17449573,  0.71182545,
         0.63282332,  0.94234293,  1.09096869,  0.54811425,  1.27483108,
         0.8111608 ,  0.6484496 ,  1.24779747,  0.8394169 ,  0.92136083,
         0.9568367 ,  0.9495373 ,  0.85118215,  0.914558  ,  1.02782183,
         0.69412449,  0.46184747,  0.59576934,  0.734871  ,  0.88186662,
         0.92136083,  0.97939691,  0.74922606,  0.71635037,  0.62899189,
         1.03636904,  0.8394169 ,  0.64449701,  0.71182545,  0.66869528,
         0.76903062,  0.92825749,  0.89468784,  1.36599186,  0.60296371,
         1.26113159,  0.66869528,  0.90784649,  0.77410681,  0.7896521 ,
         0.70289664,  0.70289664,  1.31833677,  0.66458003,  0.58516823,
         0.80569626,  0.68124824,  0.9495373 ,  0.83363649,  0.93525061,
         0.8002908 ,  0.63668435,  0.57822368,  0.94234293,  0.90784649,
         0.8394169 ,  0.66869528,  0.68979545,  0.55465029,  0.63282332,
         0.82792214,  0.82792214,  0.75903029,  0.71635037,  0.94234293,
         0.64449701,  0.66049837,  0.77410681,  0.86323093,  0.68550358,
         0.33467465,  0.83363649,  0.50460856,  0.68979545,  0.67284468,
         0.75410414,  0.6484496 ,  0.68979545,  0.70734111,  0.6484496 ,
         1.26113159,  0.58867702,  0.76903062,  1.00302336,  0.48134855,
         1.01941827,  0.57822368,  0.77923506,  0.60296371,  0.85118215,
         0.914558  ,  0.64449701,  0.45912267,  1.23480973,  0.60296371,
         0.66869528,  0.73017613,  0.39542342,  0.88186662,  0.8111608 ,
         0.60660009,  1.00302336,  0.69849133,  0.50759364,  0.64449701,
         1.1206804 ,  0.97176318,  0.6484496 ,  0.53529303,  0.61767065]]))
        
        npt.assert_almost_equal(TM.adc_residuals[0][0],
        np.array([[  4.82309915e-02,   1.70665430e-01,  -6.36386566e-01,
         -1.14086706e-01,   4.69514305e-02,  -2.01901510e-01,
         -2.56756537e-01,   1.18918791e-01,   2.02502833e-01,
         -1.32558646e-01,  -9.29055181e-02,   6.17269011e-02,
         -1.73749163e-01,  -3.08427789e-02,  -1.61525773e-01,
         -1.11794187e-01,   1.16733527e-01,  -1.73007545e-01,
         -2.51596711e-02,  -1.63915007e-01,  -8.28492413e-02,
          4.31097261e-02,  -3.76434468e-01,   8.52220431e-02,
         -3.31423729e-03,  -3.49767442e-01,   3.03579376e-01,
         -2.11373227e-01,   2.01231862e-02,  -1.62762936e-01,
          1.41924581e-01,   4.83353210e-03,   1.91341783e-01,
          5.32561439e-02,   1.73268715e-01,   7.90480745e-02,
         -8.98623858e-02,  -3.33519321e-01,   1.61807498e-01,
         -1.98320567e-02,  -2.01665389e-01,  -1.95847716e-02,
          5.94129333e-02,   1.09863884e-01,   2.48049606e-01,
          3.89995783e-02,   7.10098341e-02,   8.57107136e-02,
         -6.41730863e-02,  -3.48728152e-01,   2.71567921e-01,
          8.61984835e-02,  -1.21883148e-01,   6.77790988e-02,
          1.25816633e-01,  -2.73023319e-01,   3.47872468e-02,
          2.03803659e-01,   1.46285644e-01,  -3.62910011e-01,
          1.09601403e-01,  -1.85690759e-01,   1.86373583e-01,
          9.17645445e-02,  -2.52647401e-01,   2.76149350e-01,
          3.22270468e-01,  -4.05525181e-01,   1.36569989e-03,
         -2.40813000e-01,   1.20843837e-01,   1.11983425e-01,
         -1.58708780e-01,   3.18093682e-02,  -9.10964879e-02,
          7.61854603e-02,   6.36485193e-02,   2.49221210e-01,
         -1.48778822e-02,  -3.13690144e-01,  -8.17288755e-02,
          4.94404737e-02,   1.91612381e-01,  -7.46842158e-02,
         -1.65978510e-01,   2.06629352e-01,  -1.81342194e-02,
          2.32198029e-01,   1.97546505e-01,  -3.00116432e-02,
         -2.15393358e-01,  -6.58907027e-02,  -1.00304921e-01,
          2.58164654e-01,   1.58638421e-02,   1.72458572e-01,
         -5.55394570e-02,   4.03835592e-02,  -5.33836737e-02,
         -9.75321262e-02,   4.69173252e-02,  -3.55455065e-02,
         -2.69422763e-02,   9.68703027e-02,   1.31461684e-01,
          2.58906646e-02,   3.91284514e-02,  -9.75517303e-02,
          7.50083667e-03,   2.15467562e-01,   1.08510740e-01,
          1.95978147e-03,   1.06323050e-01,   6.92950678e-03,
         -1.86513522e-01,   1.12233613e-01,   2.25422860e-02,
         -4.50623981e-01,   3.40313331e-02,   8.38509342e-02,
          7.19461515e-02,   1.97649559e-01,   3.27775718e-01,
          9.84268924e-02,   6.15469767e-02,   7.21584579e-02,
         -4.91553833e-02,   3.46620444e-02,   1.94693115e-01,
          1.79509550e-01,  -2.37784628e-01,  -7.32868171e-01,
          1.28677115e-01,  -8.36904681e-02,   2.23138127e-01,
         -2.70990641e-01,   1.05479439e-01,  -6.76171615e-02,
         -5.12112737e-02,  -6.68770500e-02,   2.12180095e-01,
         -1.22091241e-01,   4.41982247e-02,  -1.82227600e-02,
          9.74726514e-02,  -1.77064133e-02,  -1.42540528e-01,
         -5.84484958e-02,   1.49865593e-01,  -7.78151830e-02],
       [  3.61965144e-02,  -8.20165417e-02,   1.85960894e-01,
         -2.82736568e-01,   1.14888176e-01,  -1.86827940e-01,
          2.58106951e-01,  -6.09541355e-02,   2.65444683e-01,
          5.54037934e-02,   1.05875861e-01,  -3.24110299e-02,
         -3.78269330e-01,   2.34931083e-02,  -4.45973466e-02,
         -1.33308792e-01,   2.23129837e-01,  -3.31921952e-01,
         -1.16947467e-01,   1.67039892e-01,  -4.57372239e-02,
          6.27590799e-03,  -9.61155554e-02,   1.32329277e-01,
          7.55052024e-02,   6.92861750e-02,   2.89222101e-01,
         -2.24231982e-01,   8.44963948e-02,   7.66209383e-02,
          5.54944910e-02,  -1.23599050e-01,  -2.01598669e-02,
         -1.37129238e-01,   3.93055362e-02,   7.38534927e-02,
          1.63908164e-01,   1.65185009e-01,  -7.55732523e-01,
          1.40092331e-01,  -1.70501151e-01,  -2.66457816e-01,
          2.15686720e-01,   1.58601001e-01,   6.20254192e-02,
         -3.19493000e-01,   2.05874730e-01,  -2.41066927e-01,
          1.40620497e-01,  -1.21735380e-01,   1.98557570e-01,
         -1.27494071e-01,  -1.74942246e-01,   1.35804793e-01,
          1.27501089e-01,   5.07361063e-02,  -4.04276676e-01,
         -8.18283272e-03,  -1.50260116e-02,   5.06276722e-02,
          3.51301291e-02,   7.82344752e-02,   2.57433234e-02,
          5.79984010e-02,  -1.86833755e-01,   8.00720372e-03,
         -4.42690876e-02,   1.22565184e-01,  -1.62367779e-01,
          1.10147950e-01,   2.10917407e-01,   4.12912001e-02,
         -7.17840060e-02,   1.28902277e-01,   8.82704762e-02,
         -1.03504137e-01,  -5.39251604e-02,   1.89467264e-01,
         -1.24046736e-01,   3.75184128e-02,   3.84327464e-02,
          4.93805128e-02,   3.41095661e-01,  -9.11046890e-03,
          9.56162389e-02,   2.51682886e-01,  -1.14892097e-01,
          1.63030151e-01,   1.11755656e-01,   3.75845110e-02,
         -3.27937515e-01,   1.25299605e-01,   1.03909471e-01,
         -5.17539068e-03,  -9.01581671e-02,  -2.80304419e-01,
         -2.28247766e-01,  -1.96851788e-01,   5.59973161e-02,
         -9.88901194e-02,  -4.09435993e-01,   2.34800852e-01,
          1.15686710e-01,   1.32073800e-02,  -2.64294570e-01,
          6.91611869e-02,   1.02856765e-01,  -2.97309095e-01,
         -6.62125412e-02,   1.23402312e-01,   5.23511771e-02,
         -1.46627395e-01,   1.71295139e-01,   2.49140122e-02,
         -2.00733716e-01,  -6.25503484e-01,  -5.22623307e-02,
          1.69547798e-01,   2.46940348e-01,  -7.73601789e-02,
         -5.78495825e-02,   8.63530879e-02,   2.92039426e-01,
          1.19612560e-01,  -3.12293352e-02,  -3.86502405e-03,
          5.58956124e-02,  -1.57381318e-01,  -1.17212100e-01,
         -7.04610855e-02,   1.16926419e-01,   7.45251778e-02,
          1.90468133e-01,   2.06070511e-02,   5.23642466e-03,
         -9.93717073e-02,   3.34127528e-02,   1.53466344e-01,
         -1.29819504e-01,   1.54885050e-01,   2.92036331e-02,
         -2.02697808e-01,   1.22178575e-01,   1.55022075e-01,
          8.36214505e-02,   2.12439868e-01,   3.83185870e-03,
         -2.00184850e-02,   1.85945707e-01,  -7.67157431e-02],
       [ -7.58392058e-02,   1.61004603e-01,   1.02571878e-01,
         -1.63215824e-01,   5.01025825e-02,   1.40934429e-01,
          1.05735060e-01,   1.21034335e-02,   6.14332461e-04,
          1.41618567e-01,   1.40276415e-01,   4.89956841e-02,
          3.24749366e-02,   2.39678902e-01,   1.10947147e-01,
         -1.95891271e-03,   1.71827684e-01,   4.69570598e-03,
          7.32672653e-02,  -1.22012510e-01,  -2.57544876e-01,
          5.78722778e-02,   2.42522285e-01,   3.86195022e-02,
          1.88062337e-02,   4.28617313e-02,   1.71446871e-01,
          1.90016054e-01,  -7.94840396e-02,   2.68578092e-01,
          2.05716379e-01,   9.28606281e-02,   1.68032001e-01,
         -2.64610725e-02,   6.78444399e-02,   1.71617520e-01,
          8.54445713e-02,   2.45131620e-01,  -9.28591089e-02,
          1.24117291e-01,   1.04261858e-02,  -4.81095974e-01,
         -4.27814333e-02,   5.13287175e-02,  -5.86314652e-02,
         -2.37958547e-02,   2.82595313e-01,  -1.21626520e-01,
         -2.36868922e-01,  -2.62901182e-01,  -1.93849446e-01,
          1.32781435e-01,  -9.33918466e-02,   1.10453603e-02,
          7.77388337e-03,   2.51851989e-02,  -5.12604277e-04,
         -1.69500043e-02,  -1.43529686e-01,   2.38107509e-02,
         -3.97152271e-02,   4.28276455e-02,   8.93503240e-02,
          6.12119702e-02,   4.18262297e-02,  -6.36001911e-01,
         -1.07470240e-02,   1.68477973e-01,  -1.26353545e-01,
          4.24641448e-01,   1.52233151e-02,   4.03626197e-02,
          1.86937115e-01,   5.19207723e-02,   8.07897460e-02,
          7.90414082e-02,   3.24365269e-02,   2.22287178e-01,
         -2.35583983e-01,  -1.92664263e-01,   2.71584931e-02,
          4.95381391e-02,   2.41727132e-01,  -6.25127837e-04,
         -2.61399102e-02,   2.05335786e-01,  -3.86881906e-01,
          4.23686743e-02,  -1.17631900e-01,  -2.48085434e-01,
          4.87712793e-03,  -1.11046751e-01,   5.02467577e-02,
          1.95933611e-03,   3.80112580e-02,   9.77860373e-03,
         -5.26824127e-02,   1.45058230e-01,   8.59456425e-02,
         -3.26062818e-01,  -2.92449001e-01,   2.69646451e-01,
         -3.68782396e-01,  -2.60081060e-01,   9.95695709e-02,
         -1.71506283e-02,   7.28766443e-02,  -1.61046846e-01,
         -5.34951435e-02,  -3.46764888e-02,   1.38445194e-01,
         -9.26275247e-02,  -4.41160166e-02,  -7.60552852e-01,
          3.29461265e-03,   3.76172215e-03,  -1.41036763e-01,
          6.79153819e-02,   8.49368442e-02,  -1.33634911e-01,
          7.39071647e-02,   6.14896042e-02,   4.39065190e-01,
          1.87818137e-02,   5.89727493e-02,   1.00042698e-01,
          5.74948329e-02,  -3.62162630e-02,  -8.51460752e-02,
         -1.50828126e-02,  -2.19656577e-01,   8.74409597e-02,
         -3.99826261e-02,   1.72818468e-01,   6.94315063e-02,
         -1.40060852e-01,  -5.15311697e-01,  -1.74259606e-01,
         -3.45226169e-01,  -3.24569379e-01,  -2.84223108e-02,
          7.66187843e-02,   1.71075000e-01,   1.85636197e-01,
          2.85117351e-02,   1.45530763e-01,  -1.33349550e-01,
         -1.81407895e-01,   1.77133453e-01,   1.59499894e-01],
       [  3.95171169e-04,   2.44338238e-01,   4.31805969e-02,
         -9.25281421e-02,  -2.35426414e-01,  -8.28108084e-02,
          8.56968943e-02,  -7.88862671e-02,   2.18296538e-01,
          1.43745507e-01,   8.52751769e-02,   1.26726775e-01,
          2.52605802e-02,   9.94349781e-02,  -7.35917528e-02,
         -5.95982589e-02,   3.13719205e-02,  -3.14792495e-02,
          4.68196821e-02,   1.35585463e-01,  -5.87414457e-01,
          2.79718372e-02,   3.24977718e-02,  -5.03374542e-02,
          1.28224203e-02,  -4.39060740e-02,   1.73414399e-01,
          2.38834202e-01,  -1.35129564e-01,   1.96677753e-01,
          5.28233778e-02,   1.32648682e-01,   1.96453883e-01,
         -6.81228947e-02,   1.49459450e-01,   4.78593572e-02,
         -9.23791038e-02,  -1.12858118e-01,  -1.80756894e-01,
          1.31332580e-01,   1.15709945e-01,   1.85736790e-03,
         -1.03667728e-01,   2.13933307e-04,  -4.68682719e-01,
          2.69247047e-02,   1.64290649e-01,  -3.00514487e-01,
         -1.72989271e-01,   9.33718239e-03,  -6.96447881e-02,
         -1.73361519e-01,   2.81867951e-02,  -1.18568411e-02,
         -2.30642512e-01,   6.04330912e-02,   1.43771569e-01,
          2.09255628e-01,  -1.43381712e-01,  -2.56887602e-01,
         -1.04079927e-01,   2.16474029e-02,   5.18130256e-04,
         -2.40256794e-03,   2.08275356e-01,  -2.47176692e-01,
         -2.55490689e-02,   2.19050479e-01,   8.53265514e-02,
          2.29655844e-01,   5.39895434e-02,  -1.14553539e-01,
         -4.48741297e-02,  -4.19214575e-01,  -6.53425928e-02,
         -3.52753927e-01,   2.21146792e-01,  -1.64892723e-01,
         -7.33010318e-02,  -1.64367444e-01,   1.10014311e-01,
         -7.18955324e-04,  -3.22053620e-01,   7.88864460e-02,
          1.16510941e-01,   1.20961153e-01,   9.59378495e-02,
         -4.44650438e-02,  -1.59796604e-02,  -8.79713760e-02,
          1.02895891e-01,   3.31555834e-02,   1.57100781e-02,
          4.80543591e-03,   1.88234526e-02,  -2.61197943e-02,
          1.59750194e-02,  -6.25608492e-02,   1.61361746e-02,
          6.72405437e-02,   2.14836132e-02,   3.02742176e-02,
          2.10203647e-01,  -1.18059979e-01,  -2.09375633e-01,
          1.58933214e-01,   2.88165298e-02,   6.74022917e-02,
         -1.74662930e-01,   2.82162116e-01,   2.68782277e-01,
          2.32940943e-02,   2.94972543e-01,   1.08399765e-01,
          2.65650831e-03,  -5.64971119e-02,   5.60343822e-03,
          1.85994974e-01,   7.09731430e-02,   5.13573626e-02,
         -4.13133037e-01,   1.69994966e-01,   1.60587268e-01,
         -4.02734756e-02,   8.06417177e-02,  -2.41056636e-01,
          8.34137936e-02,  -1.70558067e-01,   2.65498825e-03,
         -1.56775280e-01,  -6.10342881e-02,   8.28769990e-02,
          8.45493851e-02,  -3.94166935e-01,   1.08388459e-01,
          9.07988795e-03,  -1.35475805e-01,   1.60254836e-01,
         -9.67170392e-02,   1.48636013e-01,  -6.16927376e-02,
         -5.11745973e-02,   1.03969670e-01,   2.70051869e-02,
         -2.27878567e-02,  -2.08897866e-01,  -2.29654759e-03,
          6.63490092e-02,   1.69860335e-01,   1.39494157e-01]]))
        

        npt.assert_almost_equal(TM.radial_diffusivity,
        np.array([[[ 0.53468378,  0.54975399,  0.55070056,  0.66474294],
        [ 0.54933705,  0.57168669,  0.5575057 ,  0.79575506]],

       [[ 0.54371964,  0.56551104,  0.63263815,  0.58737917],
        [ 0.59061967,  0.53593324,  0.53760519,  0.77688092]],

       [[ 0.52316325,  0.5653939 ,  0.6223603 ,  0.57814849],
        [ 0.52131829,  0.51687084,  0.5165984 ,  0.55457351]]]))

        npt.assert_almost_equal(TM.axial_diffusivity,
        np.array([[[ 0.72498638,  0.87160882,  0.93262054,  1.00267148],
        [ 0.77462729,  0.74914162,  0.91580675,  1.25077171]],

       [[ 0.7675704 ,  0.91662169,  0.92254438,  0.85523229],
        [ 0.77521873,  0.7947062 ,  0.90555661,  1.18773376]],

       [[ 0.78179326,  0.86322687,  0.83765462,  0.85897404],
        [ 0.78781523,  0.84462938,  0.80049902,  0.84105437]]]))
        
        npt.assert_equal(ozu.fiber_volume_fraction(TM.fractional_anisotropy),
                         TM.fiber_volume_fraction)
        
        npt.assert_almost_equal(TM.fit[0][0],
        np.array([[  88.08030854,   88.14213715,   74.98556065,   81.6597057 ,
          81.02303595,   76.37295582,   70.18837447,   93.81135568,
          80.70373682,  101.67954151,   83.08943359,   84.85079739,
         108.9951894 ,  110.61729563,  121.55761662,   90.04004297,
          91.05512338,   73.4980451 ,   93.59301101,   84.66513419,
          93.23715817,   88.98710987,   78.55404409,   75.89612159,
         118.784758  ,  102.65363104,   70.29169482,   83.93810141,
          84.52864256,   87.23979565,  109.1676289 ,   98.04757165,
          74.34112642,  109.67360821,   86.27014687,  116.96617341,
          89.76659252,   79.88680613,   71.62934629,   85.31782156,
          83.8209074 ,   79.03595563,   73.70088013,  123.62154409,
          79.76606087,   87.87169463,   97.17166951,   80.87678019,
         104.59907931,   72.31092626,   81.32931916,   80.79792015,
          84.21904116,   85.57637748,   83.19569206,   93.22637587,
         115.66603984,   77.83308642,  104.4878853 ,  111.58694563,
          85.13483446,   72.48680347,   84.03840356,  106.53794097,
          76.2438074 ,   97.85626691,   81.88493833,   90.01081369,
          81.77633082,   82.55391808,   84.81255226,   87.92757953,
          78.29383222,   73.19229019,  121.18441698,   86.72564206,
          78.36201686,  103.27093974,   99.92968043,  112.36189299,
          84.78544339,   87.86750292,   74.98256386,   95.21025712,
         104.52697089,   70.77955098,   95.39794294,   72.27917638,
          86.22302499,   74.33028912,   81.53877137,   93.55043033,
         108.77115853,   73.39494377,   80.40793969,   86.41004239,
         103.92592722,  116.22346828,  117.94358791,   98.44651513,
          85.58072922,   90.18903097,   78.09684396,  107.92717756,
          96.10010122,   79.76106432,  102.64467826,   81.43426089,
          96.54080854,   76.03842553,  119.12707658,   73.71052003,
          88.92864145,   85.8025825 ,  100.19652909,  109.45502132,
          95.59166346,   83.73093357,   85.01237553,   99.78149607,
          79.67025261,   92.26656263,   75.79673253,   79.66713913,
         113.17511513,   94.35185821,  104.81403222,  110.09686131,
         102.29835648,   90.78693162,   85.27328096,  103.93754324,
         122.14890126,   88.66533929,  104.32113169,   91.12873677,
         114.18283876,  122.49413575,   93.05952538,   80.01781857,
         114.48293641,   76.59463571,   83.30120852,  120.30566484,
         116.02603292,   71.48726566,   73.14283999,   93.29230227,
          94.85022585,   91.13475112],
       [  87.43553277,   88.36899714,   86.86542819,   91.53458272,
          90.59709029,   59.57451892,   68.03243297,   80.20518374,
          64.68898893,  113.67909237,   74.44323256,   78.95571715,
         112.93704893,   97.31825593,  136.66168655,  104.44328722,
          99.20272097,   83.51648351,  109.9255207 ,   98.80753846,
          77.80100313,   70.1143907 ,   89.68434287,   75.21185955,
         113.49871528,  114.0486342 ,   65.61010553,   62.63620205,
          70.09474439,   91.79767385,  123.50290811,  103.71505212,
          80.16805795,  102.61327422,   88.74234039,  127.67721082,
          98.70786196,   91.9881943 ,   63.46714539,   86.89908183,
          94.22588405,   66.45182687,   59.76469708,  131.80123995,
          82.15014871,   79.57147047,   76.8488673 ,   63.16153542,
         122.28511676,   76.54014097,   79.99853744,   87.75034971,
          72.36408592,   67.83150643,   88.34028829,  102.09621022,
         127.94552916,   89.45202785,  116.44742016,  127.42201697,
          84.82575815,   59.86106487,   94.03181696,   89.93828518,
          88.63629067,   84.63373016,   96.14668457,   68.86902045,
          89.93820541,   70.60076041,   81.98029578,   83.7869365 ,
          91.19644029,   64.9106848 ,  127.40099695,   65.18961563,
          83.54107561,   92.41970846,  112.77901525,  104.83115341,
          98.15752648,   98.74955098,   59.64994954,  101.83879519,
         106.54633133,   72.53911768,   79.27469087,   72.89792784,
          95.16499553,   82.55521546,   65.51214557,  104.29679056,
         121.85311588,   64.6658903 ,   68.2629802 ,   82.33171889,
         115.23286263,  115.63196152,  135.00140755,   91.4020907 ,
          81.6458446 ,   69.40288919,   59.50823419,  111.02814064,
         101.79222251,   90.56506342,  115.59740723,   74.30589254,
         102.74341387,   65.62863927,  114.37525263,   81.78784636,
          85.90141202,   92.2851236 ,  107.56911273,   97.828063  ,
         103.24699782,   73.37867725,   89.09702336,  116.73314803,
          92.05796309,  101.80756053,   75.83622145,   59.83006059,
         127.73405576,   91.70616019,  120.72117573,  124.66400307,
         112.51207735,   96.71214313,   80.7307849 ,   87.01409885,
         126.39596495,   78.68913933,  102.9165072 ,  102.46898972,
         131.88553466,  133.16172177,   90.75233935,   61.62371004,
         127.34087071,   68.99520523,   93.98494346,  135.68169645,
         119.2851672 ,   77.80796139,   68.47322461,   97.83982985,
          91.69407035,  107.25616764],
       [  84.95637188,  101.45681271,   81.45302148,   97.02094567,
          87.75122421,   55.06920043,   63.13269027,   92.7279581 ,
          67.91650209,  126.5613087 ,   82.33489797,   74.34585185,
         138.69293663,  109.59501934,  157.79700607,   97.38077448,
         102.83012706,   77.27089887,  104.50720485,   91.8990911 ,
          76.99428123,   68.58410939,   90.50345406,   78.68183001,
         135.79513951,  124.82733011,   61.03537137,   61.54555071,
          65.64882942,   91.16762309,  129.88921584,  103.81313261,
          72.17231434,  125.46735912,   83.81896644,  154.66477335,
          91.87773626,   86.35758578,   57.79598032,   79.57804445,
          95.97762651,   60.20083151,   57.73449221,  153.41413081,
          88.82878767,   75.50945109,   81.26000929,   58.66800023,
         122.05492949,   69.36444593,   72.20571448,   94.31323075,
          67.50052556,   64.55799851,   84.67323292,   97.94034711,
         137.14052559,   87.9308988 ,  135.9153391 ,  132.53575145,
          80.11759937,   55.99254591,   95.34460986,  103.51846416,
          83.69732747,   85.6318808 ,   88.89022368,   73.53585004,
          86.26290854,   65.0136745 ,   77.600976  ,   79.33045135,
          83.25567676,   64.89850411,  155.69619815,   64.88720948,
          74.97491425,   96.16456462,  110.52861756,  127.89845708,
          89.97752397,  107.77516105,   54.88181778,   98.12260168,
         108.5280656 ,   69.63649458,   91.05224197,   72.58153161,
          87.30173223,   82.12100854,   69.32052138,  112.38193142,
         133.84986461,   64.74578472,   62.09528768,   78.45062353,
         115.55605356,  127.93816941,  147.36237494,  109.41816344,
          75.38193225,   74.6445387 ,   58.54345518,  136.26632932,
          99.15173999,   86.93129164,  114.96133331,   81.42082997,
         105.72772723,   58.94979579,  134.19035409,   80.63619908,
          81.91811466,   86.96838689,  110.2710004 ,  107.19051689,
         120.65473452,   68.0932482 ,   86.90845297,  113.65618152,
          83.67135202,   97.27102529,   67.73613706,   58.75112119,
         144.86535171,   89.23403147,  121.22704836,  132.23979209,
         132.79293319,  111.30752346,   74.47877342,  100.74673803,
         153.82141855,   75.02355698,  105.31201688,  112.47972255,
         140.14062722,  151.61555083,   87.76317318,   57.41675383,
         151.36426031,   61.77066346,   88.06996589,  156.59731261,
         130.35092218,   72.50455978,   61.3654333 ,   99.17860291,
         108.76158705,  101.03572269],
       [  96.92336708,  104.89785644,   83.47092042,  101.0760378 ,
          94.4801985 ,   63.72682977,   66.55668988,   98.35558529,
          74.3169498 ,  134.27565208,   86.84966491,   86.14885317,
         141.65933776,  116.39121982,  158.72361695,   98.01344239,
         112.70208279,   78.8087154 ,  104.72027673,   93.78579723,
          87.41490274,   79.42976122,   94.64423557,   81.83786237,
         139.37941094,  133.19752711,   65.03722371,   71.32620027,
          77.30793261,  101.89311082,  134.0616207 ,  112.74574308,
          74.26001128,  129.49387828,   91.96082441,  157.20848904,
          95.03127615,   90.23183968,   63.16203589,   85.35892734,
         103.14281281,   69.74045087,   63.98055281,  153.93412264,
          91.91685106,   86.22930604,   90.71299381,   69.3117978 ,
         121.55001663,   71.64942122,   78.16306968,   97.5953202 ,
          79.39562045,   75.77578446,   93.58054121,  101.90754147,
         137.26907013,   92.12360112,  141.2035574 ,  132.05560133,
          89.89292995,   62.2458872 ,  102.89332045,  110.5298369 ,
          86.37053702,   95.08739293,   90.5086507 ,   81.94810066,
          93.58565363,   76.43791613,   88.86699052,   90.53832092,
          84.23021301,   69.38193502,  157.26603642,   74.92036629,
          77.74987637,  104.30022911,  113.47352415,  131.97490345,
          90.68202858,  113.16260078,   62.84144456,  104.19333384,
         113.2754824 ,   72.23078001,   97.39831643,   75.4172925 ,
          89.82536885,   84.65825551,   75.70223708,  120.72331057,
         140.51490749,   69.33046155,   72.22896974,   90.61202086,
         117.1951515 ,  131.46121821,  147.17291261,  113.64202351,
          84.29896506,   82.8298397 ,   66.33470554,  139.29588273,
         106.40435522,   92.41789776,  116.11154174,   85.64089336,
         116.28512021,   66.54308973,  137.86393928,   83.03979328,
          93.13209796,   93.39059653,  119.3641287 ,  114.2017975 ,
         124.59581652,   79.96589597,   97.17880045,  113.7004299 ,
          84.53655007,  101.0724035 ,   71.80436833,   67.20054356,
         149.78494413,   97.16959307,  122.72010033,  136.43210798,
         137.26916532,  114.93506993,   83.60753683,  107.60133862,
         155.37429111,   85.78940524,  111.10511858,  118.82249843,
         140.29964316,  151.68781792,   95.85934213,   67.59861407,
         154.99089932,   68.68175436,   92.59721897,  158.21952045,
         132.9220412 ,   74.41191158,   66.30384153,  110.34191781,
         112.49112881,  101.37753175]]))

        # The Westin Geometrical measures should sum to 1: 
        npt.assert_almost_equal(TM.planarity +
                         TM.linearity +
                         TM.sphericity, np.ones(TM.planarity.shape))


# We'll use these two identical models in a few tests below:
TM1 = TensorModel(data_path + 'small_dwi.nii.gz',
                          data_path + 'dwi.bvecs',
                          data_path + 'dwi.bvals')
    
TM2 = TensorModel(data_path + 'small_dwi.nii.gz',
                          data_path + 'dwi.bvecs',
                          data_path + 'dwi.bvals')
    
def test_tensor_stats():
    """
    Test tensor_coherence and tensor_dispersion
    """

    c = tensor_coherence([TM1, TM2])
    # Coherence should be 1 everywhere:
    npt.assert_almost_equal(c,np.ones(c.shape))

    # Dispersion should be 0 everywhere: 
    d = tensor_dispersion([TM1, TM2])
    npt.assert_almost_equal(d,np.zeros(d.shape))

def test_predict():
    """
    Test prediction on new directions
    """
    bvecs = TM1.bvecs[:, TM1.b_idx]
    # We take a subset of these and pass them to the predict method:
    new_bvecs = bvecs[:, :4]
    prediction = TM1.predict(new_bvecs)

    # Then verify that the prediction is equal to the fit in these directions:
    npt.assert_array_equal(prediction, TM1.fit[...,:4])
